---
import Layout from '~/layouts/PageLayout.astro';
import HeroText from '~/components/widgets/HeroText.astro';
import { getCollection } from 'astro:content';

const metadata = {
  title: 'OQF - O Que Funciona',
};

// Get the OQF data
const oqfData = await getCollection('oqf');
const data = oqfData[0]?.data;

if (!data) {
  throw new Error('OQF data not found');
}

const { title, subtitle, categories, interventions } = data;

const effectBaseLabels = {
  positivo: 'Positivo',
  negativo: 'Negativo',
  neutro: 'Neutro',
} as const;

const effectStrengthLabels = {
  fraco: 'fraco',
  moderado: 'moderado',
  forte: 'forte',
  indeterminado: '',
} as const;

const effectCirclePalette = {
  positivo: {
    fraco: 'bg-emerald-300',
    moderado: 'bg-emerald-500',
    forte: 'bg-emerald-700',
    indeterminado: 'bg-emerald-400',
  },
  negativo: {
    fraco: 'bg-rose-300',
    moderado: 'bg-rose-500',
    forte: 'bg-rose-700',
    indeterminado: 'bg-rose-400',
  },
  neutro: {
    fraco: 'bg-slate-400',
    moderado: 'bg-slate-500',
    forte: 'bg-slate-600',
    indeterminado: 'bg-slate-400',
  },
} as const;

const defaultEffectCircle = 'bg-slate-400';

const indicatorBaseClass = 'mt-1 flex-none h-4 w-4 rounded-full';

const getEffectLabel = (direction: string, strength: string) => {
  const base = effectBaseLabels[direction as keyof typeof effectBaseLabels] ?? 'Indeterminado';
  if (direction === 'neutro' || strength === 'indeterminado') {
    return base;
  }
  const strengthLabel = effectStrengthLabels[strength as keyof typeof effectStrengthLabels];
  return strengthLabel ? `${base} ${strengthLabel}` : base;
};

const getEffectCircleClass = (direction: string, strength: string) => {
  const palette = effectCirclePalette[direction as keyof typeof effectCirclePalette];
  if (palette) {
    return palette[strength as keyof typeof effectStrengthLabels] ?? defaultEffectCircle;
  }
  return defaultEffectCircle;
};

const complexityLabels = {
  simples: 'Simples',
  moderada: 'Moderada',
  complexa: 'Complexa',
  'nao-informado': 'Sem informação',
} as const;

const complexityCirclePalette = {
  simples: 'bg-emerald-400',
  moderada: 'bg-amber-500',
  complexa: 'bg-rose-500',
  'nao-informado': 'bg-slate-400',
} as const;

const getComplexityLabel = (value?: string) =>
  complexityLabels[value as keyof typeof complexityLabels] ?? 'Sem informação';

const getComplexityCircleClass = (value?: string) =>
  complexityCirclePalette[value as keyof typeof complexityCirclePalette] ?? 'bg-slate-400';

const costLabels = {
  baixo: 'Baixo',
  medio: 'Médio',
  alto: 'Alto',
  'sem-informacao': 'Sem informação',
  variavel: 'Variável',
} as const;

const costCirclePalette = {
  baixo: 'bg-emerald-400',
  medio: 'bg-amber-500',
  alto: 'bg-rose-600',
  'sem-informacao': 'bg-slate-400',
  variavel: 'bg-sky-500',
} as const;

const getCostLabel = (value: string) => costLabels[value as keyof typeof costLabels] ?? 'Sem informação';

const getCostCircleClass = (value: string) =>
  costCirclePalette[value as keyof typeof costCirclePalette] ?? 'bg-slate-400';

const formatDimensions = (items?: string[]) =>
  items && items.length > 0 ? items.join(', ') : 'Sem informação';

const hasText = (value?: string) => Boolean(value && value.trim().length > 0);
---

<Layout metadata={metadata}>
  <!-- Hero Section -->
  <HeroText
    tagline="Avaliação de políticas públicas"
    title={title}
    subtitle={subtitle}
  />

  <!-- Filter and Table Section -->
  <section class="relative not-prose">
    <div class="relative mx-auto max-w-7xl px-4 sm:px-6 py-8">
      <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6">
        
        <!-- Filters -->
        <div class="mb-8">
          <h3 class="text-lg font-semibold mb-4 text-gray-900 dark:text-white">Filtros</h3>
          
          <div class="flex flex-wrap gap-4 mb-4">
            <!-- Category Filter -->
            <div class="relative">
              <select 
                id="category-filter" 
                class="appearance-none bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md px-4 py-2 pr-8 text-gray-700 dark:text-gray-200 focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent"
              >
                <option value="">Selecione uma categoria</option>
                {categories.map((category) => (
                  <option value={category}>{category}</option>
                ))}
              </select>
              <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-700 dark:text-gray-200">
                <svg class="fill-current h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20">
                  <path d="M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 5.757 6.586 4.343 8z"/>
                </svg>
              </div>
            </div>

            <!-- Search -->
            <div class="flex-1 max-w-md mb-4">
              <input 
                type="text" 
                id="search-input"
                placeholder="Buscar por intervenção"
                class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-700 dark:text-gray-200 focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent"
              />
            </div>
          </div>
        </div>

        <!-- Interventions Table -->
        <div class="overflow-x-auto">
          <table class="w-full border-collapse min-w-[720px]">
            <thead>
              <tr class="bg-secondary text-white">
                <th class="text-left p-4 font-semibold">Intervenção</th>
                <th class="text-left p-4 font-semibold">Resultado</th>
                <th class="text-left p-4 font-semibold">Efeito</th>
                <th class="text-left p-4 font-semibold">Implementação</th>
                <th class="text-left p-4 font-semibold">Custo</th>
              </tr>
            </thead>
            <tbody id="interventions-table">
              {interventions.map((intervention, index) => (
                <>
                  <tr
                    class="intervention-row border-b border-gray-200 dark:border-gray-600 hover:bg-gray-50 dark:hover:bg-gray-700"
                    data-dimensions={(intervention.dimensions ?? []).join('|')}
                    data-index={index}
                  >
                    <td class="p-4 align-top">
                      <button
                        class="text-left w-full hover:text-primary transition-colors intervention-toggle"
                        data-index={index}
                        aria-expanded="false"
                      >
                        {intervention.name}
                      </button>
                    </td>
                    <td class="p-4 align-top">
                      <div class="text-gray-900 dark:text-white font-normal">
                        {intervention.resultado}
                      </div>
                    </td>
                    <td class="p-4 align-top">
                      <div class="flex items-start gap-3">
                        <span
                          class={`${indicatorBaseClass} ${getEffectCircleClass(
                            intervention.effectDirection,
                            intervention.effectStrength
                          )}`}
                          aria-hidden="true"
                        ></span>
                        <div>
                          <div class="font-normal text-gray-900 dark:text-white">
                            {getEffectLabel(intervention.effectDirection, intervention.effectStrength)}
                          </div>
                        </div>
                      </div>
                    </td>
                    <td class="p-4 align-top">
                      <div class="flex items-start gap-3">
                        <span
                          class={`${indicatorBaseClass} ${getComplexityCircleClass(
                            intervention.implementationComplexity
                          )}`}
                          aria-hidden="true"
                        ></span>
                        <div>
                          <div class="font-normal text-gray-900 dark:text-white">
                            {getComplexityLabel(intervention.implementationComplexity)}
                          </div>
                        </div>
                      </div>
                    </td>
                    <td class="p-4 align-top">
                      <div class="flex items-start gap-3">
                        <span
                          class={`${indicatorBaseClass} ${getCostCircleClass(intervention.costLevel)}`}
                          aria-hidden="true"
                        ></span>
                        <div>
                          <div class="font-normal text-gray-900 dark:text-white">
                            {getCostLabel(intervention.costLevel)}
                          </div>
                        </div>
                      </div>
                    </td>
                  </tr>
                  <tr
                    class="intervention-detail-row hidden border-b border-gray-200 dark:border-gray-600"
                    data-detail-index={index}
                  >
                    <td colspan={5} class="bg-gray-50 dark:bg-gray-700/50 px-6 py-5">
                      <div class="text-sm text-gray-700 dark:text-gray-200">
                        <div class="flex flex-col gap-6 md:flex-row">
                          <div class="flex-1 space-y-4">
                            {hasText(intervention.summary) && (
                              <p class="leading-relaxed">{intervention.summary}</p>
                            )}

                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                              <div>
                                <span class="font-semibold">Status:</span>
                                <span class="ml-1">{intervention.status}</span>
                              </div>
                              <div>
                                <span class="font-semibold">Dimensão:</span>
                                <span class="ml-1">{formatDimensions(intervention.dimensions)}</span>
                              </div>
                              <div>
                                <span class="font-semibold">Autores:</span>
                                <span class="ml-1">{hasText(intervention.authors) ? intervention.authors : 'Sem informação'}</span>
                              </div>
                              <div>
                                <span class="font-semibold">Data da revisão:</span>
                                <span class="ml-1">{hasText(intervention.reviewDate) ? intervention.reviewDate : 'Sem informação'}</span>
                              </div>
                            </div>

                            {hasText(intervention.title) && (
                              <p class="text-sm">
                                <span class="font-semibold">Título do estudo:</span>
                                <span class="ml-1">{intervention.title}</span>
                              </p>
                            )}

                            {intervention.studyLink && (
                              <a
                                href={intervention.studyLink}
                                target="_blank"
                                rel="noopener noreferrer"
                                class="inline-flex items-center gap-2 text-primary hover:text-primary-dark transition-colors"
                              >
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"/>
                                </svg>
                                Acesse o estudo completo
                              </a>
                            )}
                          </div>

                          {(hasText(intervention.implementationNotes) || hasText(intervention.costDescription)) && (
                            <div class="w-full md:w-64 space-y-5">
                              {hasText(intervention.implementationNotes) && (
                                <div>
                                  <div class="flex items-center gap-2 text-sm font-semibold text-gray-900 dark:text-white">
                                    <span
                                      class={`${indicatorBaseClass} ${getComplexityCircleClass(intervention.implementationComplexity)}`}
                                      aria-hidden="true"
                                    ></span>
                                    <span>
                                      Implementação — {getComplexityLabel(intervention.implementationComplexity)}
                                    </span>
                                  </div>
                                  <p class="mt-1 text-sm text-gray-600 dark:text-gray-300">
                                    {intervention.implementationNotes}
                                  </p>
                                </div>
                              )}

                              {hasText(intervention.costDescription) && (
                                <div>
                                  <div class="flex items-center gap-2 text-sm font-semibold text-gray-900 dark:text-white">
                                    <span
                                      class={`${indicatorBaseClass} ${getCostCircleClass(intervention.costLevel)}`}
                                      aria-hidden="true"
                                    ></span>
                                    <span>
                                      Custo — {getCostLabel(intervention.costLevel)}
                                    </span>
                                  </div>
                                  <p class="mt-1 text-sm text-gray-600 dark:text-gray-300">
                                    {intervention.costDescription}
                                  </p>
                                </div>
                              )}
                            </div>
                          )}
                        </div>
                      </div>
                    </td>
                  </tr>
                </>
              ))}
            </tbody>
          </table>
        </div>

        {/* No results message */}
        <div id="no-results" class="hidden text-center py-8 text-gray-500 dark:text-gray-400">
          Nenhuma intervenção encontrada com os filtros aplicados.
        </div>

      </div>
    </div>
  </section>

  <!-- Information Sections -->
  <section class="relative not-prose">
    <div class="relative mx-auto max-w-7xl px-4 sm:px-6 py-12">
      
      <!-- O que é? -->
      <div class="mb-12">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-8">
          <h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-4">O que é?</h2>
          <p class="text-gray-700 dark:text-gray-300 leading-relaxed">
            O <span class="text-accent font-bold">OQF</span> é um <span class="italic">hub</span> de evidências que, como outros no <a href="https://coalizaopelasevidencias.org.br/" class="text-decoration-underline text-accent" target="_blank" rel="noopener noreferrer">Brasil</a> e no <a href="https://www.gov.uk/guidance/what-works-network" class="text-decoration-underline text-accent" target="_blank" rel="noopener noreferrer">mundo</a>, visa melhorar a forma como governos e outras organizações do setor privado e da sociedade civil criam, partilham e utilizam evidências de alta qualidade na tomada de decisões.
          </p> <br>
          <p class="text-gray-700 dark:text-gray-300 leading-relaxed">
            A partir de sólido conhecimento teórico e metodológico no âmbito do <span class="text-accent font-bold">MAPE</span> (Laboratório de Monitoramento e Avaliação de Políticas e Eleições do IESP-UERJ), sistematizamos evidências em diversas áreas de políticas públicas para determinar quais tipos de intervenções são mais eficientes em termos de resultados, e como podemos responder questões candentes no debate público.
          </p> <br>
          <p class="text-gray-700 dark:text-gray-300 leading-relaxed">
            Essas evidências são agregadas e produzidas a partir de revisões sistemáticas da literatura científica. Seguindo boas práticas nacionais e internacionais, sistematizamos trabalhos acadêmicos (sejam artigos, teses, dissertações ou outras revisões de literatura) que analisam a escala do efeito (se positivo, negativo ou misto); sua força (nível de impacto); qual o mecanismo que possibilita o resultado (como e por que algo funciona); se há moderadores (quando e porquê algo funciona); a implementação (como fazer); as percepções dos stakeholders em relação à política; e os custos envolvidos no tipo de intervenção.
          </p> <br>
          <p class="text-gray-700 dark:text-gray-300 leading-relaxed">
            A <span class="italic">toolkit</span> (ou caixa de ferramentas) de avaliação de políticas públicas que usamos têm os seguintes itens:
          </p><br>
          <ul class="list-disc pl-6 text-gray-700 dark:text-gray-300">
            <li><strong>Escala do efeito</strong> - Efeito positivo, misto ou negativo sobre o resultado.</li>
            <li><strong>Força do efeito</strong> - Força do efeito a partir da evidência disponível.</li>
            <li><strong>Mecanismo (como funciona?)</strong> - Como a política (X) se liga ao seu efeito (Y).</li>
            <li><strong>Moderador (onde, quando e com quem funciona?)</strong> - Contexto de funcionamento (ou não) da política.</li>
            <li><strong>Implementação (como fazer?)</strong> - Como se dá a implementação em casos bem-sucedidos.</li>
            <li><strong>Percepção (como os stakeholders interpretam a política?)</strong> - Sentido atribuído à intervenção por beneficiários, gestores e/ou implementadores.</li>
            <li><strong>Custo (quanto custa?)</strong> - Custo da política pública e seu benefício.</li>
          </ul>

        </div>
      </div>

      <!-- Como fazemos? -->
      <div class="mb-12">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-8">
          <h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-4">Como fazemos?</h2>
          <p class="text-gray-700 dark:text-gray-300 leading-relaxed">
            Avaliar se uma política pública funcionou ou não é uma atividade que requer uma <a href="https://www.scielo.br/j/rap/a/bPM5xsjhwWgL54mdx3R7cnP/abstract/?lang=pt" class="text-decoration-underline text-accent" target="_blank" rel="noopener noreferrer">metodologia própria</a>. Quando pensamos em efetividade, efeito ou impacto dialogamos com o conceito de <a href="https://www.cambridge.org/core/journals/political-analysis/article/abs/statistics-of-causal-inference-a-view-from-political-methodology/314EFF877ECB1B90A1452D10D4E24BB3" class="text-decoration-underline text-accent" target="_blank" rel="noopener noreferrer">causalidade</a> e suas implicações. Por exemplo: como é possível isolar o efeito de X (a política) sobre Y (o resultado)? Em termos contrafactuais, o que teria ocorrido com Y caso X não tivesse ocorrido? Além disso, outras questões são relevantes, por exemplo: Como a política funciona? Por que (não) funciona? Em que contextos o impacto é maior? Qual a percepção de beneficiários, gestores ou implementadores (stakeholders da política)? Para dar conta dessas diferentes perguntas, avaliamos políticas através da literatura, com o uso de <a href="https://journals.sagepub.com/doi/10.1177/0739456X17723971" class="text-decoration-underline text-accent" target="_blank" rel="noopener noreferrer">revisão sistemática</a> (RS).
          </p><br>
          <p class="text-gray-700 dark:text-gray-300 leading-relaxed">
            Em linhas gerais, a RS se caracteriza como um método de localizar, selecionar, sintetizar e analisar evidências. O "sistemático" na RS provém da adoção de um protocolo ex ante para cada uma dessas etapas, de modo que o processo seja reproduzível e replicável. Há dois benefícios nesta escolha: por um lado, diminui os vieses no processo de escolha de trabalhos que serão lidos e analisados e, por outro, incrementa a transparência da pesquisa.
          </p><br>
          <p class="text-gray-700 dark:text-gray-300 leading-relaxed">
            O uso de RS para avaliação, usualmente, segue uma escala: desde perguntas mais amplas (focadas no problema), até perguntas mais restritas (focadas na política/intervenção). Na área de educação, por exemplo, uma pergunta mais ampla é: "o que funciona para melhorar o desempenho dos/as estudantes?" (1); enquanto uma pergunta mais específica é: "o incremento salarial de professores por meta alcançada melhora o desempenho dos/as estudantes?" (2). No meio do caminho, há ainda a possibilidade de avaliação de uma intervenção específica (incremento salarial de professores) sobre uma série de outcomes (resultados) distintos: "quais os impactos do incremento salarial de professores" (3)? Nossa proposta é melhor indicada para responder questões como 2 e 3, dado que o foco principal da busca, filtragem, sistematização e análise está na intervenção/política pública (X).
          </p><br>
            <p class="text-gray-700 dark:text-gray-300 leading-relaxed">
              Partimos de metodologia própria de revisão sistemática para avaliação sistemática (<a href="https://osf.io/preprints/osf/aht4j_v1" class="text-decoration-underline text-accent" target="_blank" rel="noopener noreferrer">disponível aqui</a>), bem como integramos revisões já realizadas sobre intervenções em diferentes áreas temáticas (Meio-Ambiente, Economia, Sociedade, Finanças, Recursos Humanos, Assistência Social e Direitos Humanos, Energia e Internet, Educação, Saúde, Transporte, Habitação e Zoneamento, Segurança e Corrupção e Transparência). Um de nossos diferenciais é a agregação, <a href="https://pp.nexojornal.com.br/ponto-de-vista/2025/11/07/o-que-funciona-uma-proposta-de-metodologia-para-sintetizar-evidencias-e-avaliar-politicas-publicas" class="text-decoration-underline text-accent" target="_blank" rel="noopener noreferrer">em formato sequencial, de evidências quantitativas e qualitativas</a>. 
            </p><br>
        </div>
      </div>

      <!-- Por que fazemos? -->
      <div class="mb-12">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-8">
          <h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-4">Por que fazemos?</h2>
          <p class="text-gray-700 dark:text-gray-300 leading-relaxed">
            Um dos grandes desafios para o uso de avaliações no processo de formulação e tomada de decisão em políticas é o acesso, em formato acessível, dos achados de trabalhos acadêmicos.
          </p><br>
          <p class="text-gray-700 dark:text-gray-300 leading-relaxed">
            Estratégias de divulgação e disseminação de seus achados, especialmente no caso de políticas públicas, devem ser pensadas com cuidado, para que possam ser úteis ao processo de avaliação e implementação de políticas. A literatura aponta alguns fatores importantes para disseminação efetiva de achados: (i) a questão abordada é relevante socialmente/politicamente; (ii) há clareza na mensagem; (iii) o conteúdo é acessível (mesmo que o produto final seja um artigo, esse material vem acompanhado de, por exemplo, um resumo executivo); (iv) a divulgação se dá em relação com tomadores de decisão; e (v) há um balanceamento entre a rapidez da produção e a qualidade dos resultados.
          </p><br>
          <p class="text-gray-700 dark:text-gray-300 leading-relaxed">
            A literatura sobre uso de evidências em políticas públicas ressalta a importância da comunicação clara – especialmente em termos de custos e benefícios das políticas – para que pesquisas sejam incorporadas ao processo de decisão.
          </p><br>
          <p class="text-gray-700 dark:text-gray-300 leading-relaxed">
            Com isso em mente, o <span class="text-accent font-bold">OQF</span> é um hub de evidências em formato acessível, com recursos gráficos e textos curtos.
          </p>
        </div>
      </div>
      <!-- Como ler? -->
      <div class="mb-12">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-8">
          <h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-4">Como ler?</h2>
          <p class="text-gray-700 dark:text-gray-300 leading-relaxed">
            No site apresentamos uma tabela com a nossa caixa de ferramentas para cada intervenção e resultado. Trabalhamos com perguntas de pesquisas que postulam claramente o tipo de política (Intervenção) e o tipo de Resultado analisados. Por exemplo: “o banimento do celular em salas de aulas (Intervenção) aumenta o desempenho acadêmico dos/as estudantes (Resultado)?”. Além disso, apresentamos o Efeito observado em dimensão valorativa, ou normativa, a partir da revisão, que pode ser positivo - i.e., os seus efeitos são valorativamente bons -, negativo - i.e., os seus efeitos são valorativamente ruins - ou neutro, com gradações (fraco, moderado ou forte), características da implementação (simples, moderada ou complexa) e o custo monetário da política (alto, médio, baixo ou sem informação).
          </p>
        </div>
      </div>
      <!-- Entre em contato -->
      <div class="mb-12">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-8">
          <h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-4">Entre em contato</h2>
          <p class="text-gray-700 dark:text-gray-300 leading-relaxed">
            Se você é gestor/a público/a, integrante de organização da sociedade civil ou do terceiro setor, ou pesquisador/a interessado/a em avaliação de políticas públicas, estamos abertos a construir parcerias. Nossa equipe utiliza uma metodologia rigorosa, transparente e replicável de revisão e avaliação sistemática, capaz de gerar sínteses claras sobre o que funciona, como funciona e em quais contextos funciona. Caso tenha interesse em desenvolver avaliações, aprimorar programas existentes ou responder perguntas específicas sobre impacto, ficaremos felizes em conversar e explorar possibilidades de colaboração.
          </p>
        </div>
      </div>

      <!-- Apoios -->
      <div class="mb-12">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-8">
          <h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-4">Apoios</h2>
          <ul class="list-disc pl-6 text-gray-700 dark:text-gray-300">
              <li>IESP-UERJ</li>
              <li>Programa de Pós-Graduação em Ciência Política (IESP-UERJ)</li>
              <li>Assembléia Legislativa do Rio de Janeiro (ALERJ)</li>
            </ul>
        </div>
      </div>

    </div>
  </section>

  <!-- JavaScript for interactivity -->
  <script is:inline>
    document.addEventListener('DOMContentLoaded', function() {
      const categoryFilter = document.getElementById('category-filter');
      const searchInput = document.getElementById('search-input');
      const applyBtn = document.getElementById('apply-filters');
      const clearBtn = document.getElementById('clear-filters');
      const interventionRows = document.querySelectorAll('.intervention-row');
      const interventionToggles = document.querySelectorAll('.intervention-toggle');
      const detailRows = document.querySelectorAll('.intervention-detail-row');
      const noResults = document.getElementById('no-results');

      // Toggle intervention details
      interventionToggles.forEach(toggle => {
        toggle.addEventListener('click', function() {
          const index = this.getAttribute('data-index');
          if (!index) return;
          const detailRow = document.querySelector(`.intervention-detail-row[data-detail-index="${index}"]`);
          if (!detailRow) return;

          const willShow = detailRow.classList.contains('hidden');
          detailRow.classList.toggle('hidden');
          detailRow.style.display = '';
          this.setAttribute('aria-expanded', String(willShow));
        });
      });

      // Filter functionality
      function applyFilters() {
        if (!categoryFilter || !searchInput || !noResults) return;
        
        const categoryValue = categoryFilter.value.toLowerCase();
        const searchValue = searchInput.value.toLowerCase();
        let visibleCount = 0;

        interventionRows.forEach(row => {
          const dimensions = row.getAttribute('data-dimensions')?.toLowerCase() || '';
          const text = row.textContent?.toLowerCase() || '';
          const dimensionTokens = dimensions.split('|').map((token) => token.trim()).filter(Boolean);
          const index = row.getAttribute('data-index');
          const detailRow = index ? document.querySelector(`.intervention-detail-row[data-detail-index="${index}"]`) : null;
          const toggle = row.querySelector('.intervention-toggle');

          const categoryMatch =
            !categoryValue || dimensionTokens.some((token) => token.includes(categoryValue));
          const searchMatch = !searchValue || text.includes(searchValue);
          
          if (categoryMatch && searchMatch) {
            row.style.display = '';
            if (detailRow) {
              detailRow.style.display = detailRow.classList.contains('hidden') ? 'none' : '';
            }
            visibleCount++;
          } else {
            row.style.display = 'none';
            if (detailRow) {
              detailRow.style.display = 'none';
              detailRow.classList.add('hidden');
            }
            if (toggle) {
              toggle.setAttribute('aria-expanded', 'false');
            }
          }
        });

        // Show/hide no results message
        if (visibleCount === 0) {
          noResults.classList.remove('hidden');
        } else {
          noResults.classList.add('hidden');
        }
      }

      function clearFilters() {
        if (!categoryFilter || !searchInput || !noResults) return;
        
        categoryFilter.value = '';
        searchInput.value = '';
        interventionRows.forEach(row => {
          row.style.display = '';
        });
        detailRows.forEach(row => {
          row.style.display = row.classList.contains('hidden') ? 'none' : '';
        });
        noResults.classList.add('hidden');
      }

      // Event listeners with null checks
      if (applyBtn) applyBtn.addEventListener('click', applyFilters);
      if (clearBtn) clearBtn.addEventListener('click', clearFilters);
      if (searchInput) searchInput.addEventListener('input', applyFilters);
      if (categoryFilter) categoryFilter.addEventListener('change', applyFilters);
    });
  </script>

</Layout>
